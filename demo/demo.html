<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">

<title>my directive 2</title>
<script type="text/javascript" src="angular.js"></script>
<script type="text/javascript" src="angular-animate.js"></script>
<script type="text/javascript" src="../iscroll-infinite-wf3.js"></script>
<script type="text/javascript" src="../wfInfiniteList3.js"></script>
<script>
  var app = angular.module('app1',['ngAnimate','Wangf']) ;
  app.controller('controller1' , function($scope,$http,$timeout){
    $scope.title = 'two column infinite scroll' ;
    document.title = $scope.title ;
    $scope.allHeight = new Array(0,0) ;

    $scope.datapool = new Array() ;
    $scope.datapool2 = new Array() ;
    $scope.pageSize = 20 ;
    $scope.url1 = 'http://www.hihey.com/api2/arts.php' ;
    $scope.allDataCount = 0 ;

    

    $scope.delegate = {} ;
    $scope.delegate.onData=function(el,index,lr)
    {
      if( lr==0 )
      {
        if( index < $scope.datapool.length )
          el.innerHTML = $scope.datapool[index].data ;
        else
          el.innerHTML = 'invalid index:'+index ;
      }else
      {
        if( index < $scope.datapool2.length )
          el.innerHTML = $scope.datapool2[index].data ;
        else
          el.innerHTML = 'invalid index:'+index ;
      }  
    } ;
    $scope.delegate.onCellHeight=function(index,lr)
    {
      if(lr==0)
      {
        if(index<$scope.datapool.length)
          return $scope.datapool[index].h ;
      }else
      {
        if( index<$scope.datapool2.length)
          return $scope.datapool2[index].h ;
      }
      return 0 ;
    } ;
    $scope.delegate.onCellY = function(index,lr)
    {
      if(lr==0)
      {
        if(index<$scope.datapool.length)
          return $scope.datapool[index].y ;
      }else
      {
        if( index<$scope.datapool2.length)
          return $scope.datapool2[index].y ;
      }
      return 0 ;
    } ;
    $scope.delegate.onScrollHeight = function(lr)
    {
      return $scope.allHeight[lr] ;
    } ;
    $scope.delegate.onCellIndex15 = function(index,lr)
    {
      if(lr==0)
      {
        if(index<$scope.datapool.length)
          return $scope.datapool[index].i15 ;
      }else
      {
        if( index<$scope.datapool2.length)
          return $scope.datapool2[index].i15 ;
      }
      return 0 ;
    } ;

    $scope.delegate.onPushTriggered=function(sref)
    {
      $scope.datapool = new Array() ;
      $scope.datapool2 = new Array() ;
      var y0=0 , y1=0 , i0 = 0 , i1 = 0 ;
      for(var i = 0 ; i<10 ; i++ )
      {
        $scope.datapool[i] = {data:'left-data-'+i,y:y0,h:80+parseInt(Math.random()*200),i15:i0++} ;
        $scope.datapool2[i] = {data:'right-test-'+i,y:y1,h:80+parseInt(Math.random()*200),i15:i1++} ;
        y0+=$scope.datapool[i].h ;
        y1+=$scope.datapool2[i].h ;
        if(i0==15) i0 = 0 ;
        if(i1==15) i1 = 0 ;
      }  
      $scope.allHeight = new Array(y0,y1) ;
      sref.pushPullLoadingFinished(true,false) ;
      /*
      var url1 = $scope.url1+"?page="+1+"&page_size="+
                    $scope.pageSize+"&cb=JSON_CALLBACK" ;
      var isAll = false ;
      $http.jsonp(url1)
          .success(function(data){
            $scope.allDataCount = data.count ;
            $scope.datapool = new Array() ;
            var len1 = data.result.length ;
            for(var i=0 ; i<len1 ; i++ )
            {
              $scope.datapool[i] = data.result[i] ;
            }
            var newBigLen = $scope.datapool.length ;
            if( newBigLen >= $scope.allDataCount ) isAll = true ;
            else isAll = false ;
            sref.pushPullLoadingFinished(true, isAll );
            if( !sref.isPullElementDisplay() )
            {
              sref.setPullElementDisplay(true) ;
            }
          })
          .error (function(){
            console.log('jsonp failed.') ;
            sref.pushPullLoadingFinished(false, isAll );
          });// end of $http.jsonp... */
    } ;
    $scope.delegate.getDataCount=function(lr)
    {
      if( lr==0 )
        return $scope.datapool.length ;
      else
        return $scope.datapool2.length ;
    } ;
 

    $scope.delegate.onPullTriggered=function(sref)
    {
      var l0 = $scope.datapool.length ;
      var l1 = $scope.datapool2.length ;
      var y0 = $scope.allHeight[0] ;
      var y1 = $scope.allHeight[1] ;
      var i0 = 0, i1=0 ;
      if( l0>0 ) i0 = $scope.datapool[l0-1].i15+1;
      if( l1>0 ) i1 = $scope.datapool2[l0-1].i15+1 ;
      for(var i = 0 ; i<5 ; i++ )
      {
        if(i0==15) i0 = 0 ;
        if(i1==15) i1 = 0 ;
        $scope.datapool.push({data:'left '+(l0+i),y:y0,h:80+parseInt(Math.random()*200),i15:i0++}) ;
        $scope.datapool2.push({data:'right '+(l1+i),y:y1,h:80+parseInt(Math.random()*200),i15:i1++}) ;
        y0+=$scope.datapool[i].h ;
        y1+=$scope.datapool2[i].h ;
      }  
      $scope.allHeight = new Array(y0,y1) ;
      sref.pushPullLoadingFinished(true,false) ;
      /*
      var loadFrom = index ;
      var biglen = $scope.datapool.length ;
      var isAll = false ;
      if( (loadFrom+ $scope.pageSize -1) >= biglen && 
          ( biglen < $scope.allDataCount || $scope.allDataCount==0 ) )
      {
        loadFrom = biglen ;
        var loadFromPage = parseInt(loadFrom/$scope.pageSize) + 1;
        var url1 = $scope.url1+"?page="+loadFromPage+"&page_size="+
                    $scope.pageSize+"&cb=JSON_CALLBACK" ;
        $http.jsonp(url1)
          .success(function(data){
            $scope.allDataCount = data.count ; 
            var len1 = data.result.length ;
            var start0 = (data.page-1)*$scope.pageSize ;
            for(var i=0 ; i<len1 ; i++ )
            {
              $scope.datapool[start0+i] = data.result[i] ;
            }
            var newBigLen = $scope.datapool.length ;
            if( newBigLen >= $scope.allDataCount ) isAll = true ;
            else isAll = false ;
            sref.pushPullLoadingFinished(true , isAll );
          })
          .error (function(){
            console.log('jsonp failed.') ;
            sref.pushPullLoadingFinished(false ,isAll );})
      }else
      {
        sref.pushPullLoadingFinished(false , isAll );
      }*/
    } ;


    $scope.tapped=function(el)
    {
      if( typeof(el._phase) !== 'undefined' )
        console.log(el._phase) ;
      else
      {
        var par = el.parentNode;
        if( typeof(par._phase) !== 'undefined' )
          console.log(par._phase) ;
      }
    }


    $scope.delegate.onScrollerReady=function(sref)
    {
      //sref.pushLoadBegin() ;
      //sref.setPullElementDisplay(false) ;
    }

  }) ;
</script>

<style type="text/css">
.cell{
  position: absolute;
  top: 0px ;
  left: 0px ;
  border: 0px ;
  border-bottom: 1px solid #d4d4d4 ;
  margin: 0px ;
  padding: 0px ;
  padding-top: 9px ;
  padding-left: 15px ;
  width: 100% ;
  height: 80px ;
  background-color: white ;
}
.cell>img{
  width: 57px ;
  height: 57px ;
  margin: 0px ;
  padding: 0px ;
  border-radius: 50% ;
}
.cell>h3{
  position: absolute;
  top:1px;
  left: 93px ;
  color: #151515 ;
  font-size: 16px ;
}
.cell>p{
  position: absolute;
  top: 32px; 
  left: 93px ;
  color: #696969 ;
  font-size: 12px ;
}
</style>

</head>
<body ng-app='app1' ng-controller='controller1'>
<h3>{{title}}</h3>

<wf-infinite-list3 delegate='delegate' style='position:absolute;top:44px;left:0px;width:100%;bottom:0px;'></wf-infinite-list3>

</body>
</html>